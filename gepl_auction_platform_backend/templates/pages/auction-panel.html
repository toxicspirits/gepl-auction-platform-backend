<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auction Control Panel</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 50px;
      }

      button,
      select {
        padding: 10px;
        font-size: 16px;
        margin: 10px;
      }

      table {
        width: 60%;
        margin: 20px auto;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
        cursor: pointer;
      }

      th {
        background-color: #f4f4f4;
      }

      tr:hover {
        background-color: #f1f1f1;
      }

      .selected {
        background-color: #a3d2a1 !important;
        font-weight: bold;
      }

      #messages {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
        background: #f9f9f9;
        min-height: 100px;
        overflow-y: auto;
      }

      .message {
        border-bottom: 1px solid #ddd;
        padding: 5px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h2>Player Auction System</h2>
    <!-- Category Selection -->
    <label for="category">Select Category:</label>
    <select id="category" onchange="fetchPlayers()">
      <option value="">--Select a Category--</option>
      <option value="CATEGORY_A">Category A</option>
      <option value="CATEGORY_B">Category B</option>
      <option value="CATEGORY_C">Category C</option>
    </select>
    <br />
    <br />
    <!-- Players Table -->
    <table id="playersTable">
      <thead>
        <tr>
          <th>Player Name</th>
          <th>is_player_sold</th>
          <th>is_player_auctioned</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="3">Select a category to load players.</td>
        </tr>
      </tbody>
    </table>
    <br />
    <button onclick="startAuction()" disabled id="startAuctionBtn">Start Auction</button>
    <h3>WebSocket Events:</h3>
    <div id="messages"></div>
    <script>
      const API_URL = "http://65.2.69.144:8000/api/category";
      const AUTH_TOKEN = "f117b37f398cde3c9d19e50a356a335693c10be9"; // Replace with actual token
      let selectedPlayer = null; // Store the selected player

      const socket = new WebSocket('wss://websocketgepl.aagaming.in/ws/bidding_room/auction_room?origin=wss://websocketgepl.aagaming.in');

      socket.onopen = function(event) {
        console.log('WebSocket connected');
        logMessage({
          type: 'system',
          message: 'WebSocket connected'
        });
      };

      socket.onmessage = function(event) {
        console.log('Message from server:', event.data);
        try {
          const data = JSON.parse(event.data);
          logMessage(data);
        } catch (e) {
          logMessage({
            type: 'error',
            message: 'Invalid JSON received',
            raw: event.data
          });
        }
      };

      socket.onerror = function(event) {
        console.error('WebSocket error:', event);
        logMessage({
          type: 'error',
          message: 'WebSocket encountered an error'
        });
      };

      socket.onclose = function(event) {
        console.log('WebSocket closed');
        logMessage({
          type: 'system',
          message: 'WebSocket connection closed'
        });
      };

      async function fetchPlayers() {
        const category = document.getElementById("category").value;
        const playersTable = document.getElementById("playersTable").getElementsByTagName("tbody")[0];
        const startAuctionBtn = document.getElementById("startAuctionBtn");

        playersTable.innerHTML = '<tr><td colspan="3">Loading players...</td></tr>';
        startAuctionBtn.disabled = true;
        selectedPlayer = null;

        if (!category) {
          playersTable.innerHTML = '<tr><td colspan="3">Select a category first.</td></tr>';
          return;
        }

        try {
          const response = await fetch(`${API_URL}?category=${category}`, {
            method: "GET",
            headers: {
              "Authorization": `Token ${AUTH_TOKEN}`,
              "Content-Type": "application/json"
            }
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const players = await response.json();
          playersTable.innerHTML = "";

          if (players.length === 0) {
            playersTable.innerHTML = '<tr><td colspan="3">No players found in this category.</td></tr>';
            return;
          }

          players.forEach(player => {
            const row = playersTable.insertRow();
            row.innerHTML = `<td>${player.name}</td><td>${player.is_player_sold}</td><td>${player.is_player_auctioned}</td>`;
            row.dataset.playerId = player.id;
            row.dataset.playerName = player.name;

            row.onclick = function() {
              selectPlayer(this);
            };
          });

        } catch (error) {
          console.error('Error fetching players:', error);
          playersTable.innerHTML = '<tr><td colspan="3">Failed to load players.</td></tr>';
        }
      }

      function selectPlayer(row) {
        // Remove "selected" class from all rows
        document.querySelectorAll("#playersTable tbody tr").forEach(r => r.classList.remove("selected"));

        // Highlight selected row
        row.classList.add("selected");

        // Store selected player
        selectedPlayer = {
          id: row.dataset.playerId,
          name: row.dataset.playerName
        };

        // Enable start auction button
        document.getElementById("startAuctionBtn").disabled = false;
      }

      function startAuction() {
        if (!selectedPlayer) {
          alert("Please select a player!");
          return;
        }

        const message = {
          "action": "START_PLAYER_AUCTION",
          "player_id": selectedPlayer.id
        };
        const message_2 = {
          "action": "get_next_player"
        }
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(message));
          console.log('Sent:', message);
          logMessage({
            type: 'sent',
            message: message
          });
          socket.send(JSON.stringify(message_2));
          console.log('Sent:', message_2);
          logMessage({
            type: 'sent',
            message: message_2
          });
        } else {
          console.error('WebSocket is not open');
          logMessage({
            type: 'error',
            message: 'WebSocket is not open'
          });
        }
      }

      function logMessage(data) {
        const messagesDiv = document.getElementById("messages");
        const messageElement = document.createElement("div");
        messageElement.classList.add("message");

        let formattedMessage = `<strong>${data.type.toUpperCase()}:</strong> `;

        if (data.message) {
          formattedMessage += `<pre>${JSON.stringify(data.message, null, 2)}</pre>`;
        } else if (data.raw) {
          formattedMessage += `<pre>${data.raw}</pre>`;
        }

        messageElement.innerHTML = formattedMessage;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll to the latest message
      }
    </script>
  </body>
</html>
